<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ VTOXè½¦è”ç½‘æ•…éšœè¯Šæ–­ç³»ç»Ÿ - Redis+Pythonå¼‚æ­¥å‡çº§æ–¹æ¡ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'SimHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 700;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .performance-badge {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            display: inline-block;
            font-size: 1.3em;
            font-weight: 600;
            margin: 20px 0;
            box-shadow: 0 10px 25px rgba(231, 76, 60, 0.3);
        }

        .upgrade-highlight {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 4px solid #e74c3c;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .section h3 {
            color: #34495e;
            font-size: 1.6em;
            margin: 25px 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .architecture-diagram {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 30px;
            margin: 25px 0;
            text-align: center;
        }

        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }

        .flow-box {
            background: white;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            min-width: 150px;
            text-align: center;
            position: relative;
        }

        .flow-box.current {
            background: #f39c12;
            color: white;
            border-color: #e67e22;
        }

        .flow-box.upgrade {
            background: #27ae60;
            color: white;
            border-color: #229954;
        }

        .flow-arrow {
            font-size: 2em;
            color: #3498db;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin: 25px 0;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        .comparison-table th {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-weight: 600;
        }

        .comparison-table tr:hover {
            background: #f8f9fa;
        }

        .current-system { color: #f39c12; font-weight: 600; }
        .upgraded-system { color: #27ae60; font-weight: 700; }
        .improvement { color: #e74c3c; font-weight: 700; }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 25px;
            border-radius: 15px;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
            overflow-x: auto;
            font-size: 0.9em;
            position: relative;
        }

        .code-header {
            background: #34495e;
            color: white;
            padding: 10px 20px;
            border-radius: 10px 10px 0 0;
            margin: -25px -25px 15px -25px;
            font-weight: 600;
        }

        .implementation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .impl-card {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .impl-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border-color: #e74c3c;
        }

        .impl-card.priority-high {
            border-color: #e74c3c;
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.1));
        }

        .impl-card.priority-medium {
            border-color: #f39c12;
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(230, 126, 34, 0.1));
        }

        .impl-card h4 {
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .metric-card {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .metric-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #e74c3c;
            margin: 10px 0;
        }

        .metric-improvement {
            font-size: 1.2em;
            color: #27ae60;
            font-weight: 600;
        }

        .timeline {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 35px;
            border-radius: 15px;
            margin: 25px 0;
        }

        .timeline-step {
            display: flex;
            align-items: flex-start;
            margin: 25px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .step-number {
            background: rgba(255, 255, 255, 0.9);
            color: #1e3c72;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2em;
            margin-right: 20px;
            flex-shrink: 0;
        }

        .step-content h4 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .risk-analysis {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
        }

        .risk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .risk-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
        }

        .risk-item h4 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .config-panel {
            background: #34495e;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 2.2em; }
            .section { padding: 25px; }
            .implementation-grid { grid-template-columns: 1fr; }
            .performance-metrics { grid-template-columns: 1fr; }
            .flow-diagram { flex-direction: column; }
            .risk-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æŠ¥å‘Šå¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸš€ VTOXè½¦è”ç½‘æ•…éšœè¯Šæ–­ç³»ç»Ÿ</h1>
            <h2 style="color: #34495e; margin: 10px 0;">Redis + Pythonå¼‚æ­¥å‡çº§å®æ–½æ–¹æ¡ˆ</h2>
            <div class="performance-badge">ğŸ¯ ç›®æ ‡æ€§èƒ½ï¼š1000è½¦ Ã— 50K msg/s Ã— 10-20mså»¶è¿Ÿ</div>
            <div class="upgrade-highlight">
                <strong>ğŸ“ˆ ç³»ç»Ÿå‡çº§ï¼š</strong>ä»Simple Memory Queue â†’ Rediså¼‚æ­¥é˜Ÿåˆ— | æ€§èƒ½æå‡100-1000å€
            </div>
        </div>

        <!-- ç°çŠ¶åˆ†æ -->
        <div class="section">
            <h2><span>ğŸ“Š</span> ç°çŠ¶åˆ†æä¸å‡çº§å¯¹æ¯”</h2>
            
            <div class="architecture-diagram">
                <h3>ğŸ—ï¸ å½“å‰æ¶æ„ vs å‡çº§æ¶æ„</h3>
                <div class="flow-diagram">
                    <div class="flow-box current">
                        <strong>è½¦è¾†æ•°æ®æº</strong><br>
                        WebSocketè¿æ¥
                    </div>
                    <div class="flow-arrow">â†’</div>
                    <div class="flow-box current">
                        <strong>Simple Queue</strong><br>
                        å†…å­˜é˜Ÿåˆ—(1000æ¡é™åˆ¶)
                    </div>
                    <div class="flow-arrow">â†’</div>
                    <div class="flow-box current">
                        <strong>æ•…éšœåˆ†æå™¨</strong><br>
                        åŒæ­¥å¤„ç†
                    </div>
                    <div class="flow-arrow">â†’</div>
                    <div class="flow-box current">
                        <strong>WebSocketå¹¿æ’­</strong><br>
                        å‰ç«¯å®æ—¶æ˜¾ç¤º
                    </div>
                </div>
                
                <div style="margin: 30px 0; font-size: 2em; color: #e74c3c;">â¬‡ï¸ å‡çº§å â¬‡ï¸</div>
                
                <div class="flow-diagram">
                    <div class="flow-box upgrade">
                        <strong>è½¦è¾†æ•°æ®æº</strong><br>
                        å¼‚æ­¥WebSocket
                    </div>
                    <div class="flow-arrow" style="color: #27ae60;">â†’</div>
                    <div class="flow-box upgrade">
                        <strong>Redis Streams</strong><br>
                        åˆ†å¸ƒå¼é˜Ÿåˆ—(æ— é™åˆ¶)
                    </div>
                    <div class="flow-arrow" style="color: #27ae60;">â†’</div>
                    <div class="flow-box upgrade">
                        <strong>å¼‚æ­¥åˆ†æå™¨é›†ç¾¤</strong><br>
                        å¹¶è¡Œå¤„ç†
                    </div>
                    <div class="flow-arrow" style="color: #27ae60;">â†’</div>
                    <div class="flow-box upgrade">
                        <strong>å¤šè·¯å¹¿æ’­</strong><br>
                        è´Ÿè½½å‡è¡¡
                    </div>
                </div>
            </div>

            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>æ€§èƒ½æŒ‡æ ‡</th>
                        <th>å½“å‰ Simple Queue</th>
                        <th>å‡çº§å Rediså¼‚æ­¥</th>
                        <th>æ€§èƒ½æå‡</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>æœ€å¤§å¹¶å‘è½¦è¾†</strong></td>
                        <td class="current-system">100è½¦</td>
                        <td class="upgraded-system">1000+ è½¦</td>
                        <td class="improvement">10x â†—ï¸</td>
                    </tr>
                    <tr>
                        <td><strong>æ¶ˆæ¯å¤„ç†èƒ½åŠ›</strong></td>
                        <td class="current-system">1K msg/s</td>
                        <td class="upgraded-system">50K msg/s</td>
                        <td class="improvement">50x â†—ï¸</td>
                    </tr>
                    <tr>
                        <td><strong>å“åº”å»¶è¿Ÿ</strong></td>
                        <td class="current-system">100-500ms</td>
                        <td class="upgraded-system">10-20ms</td>
                        <td class="improvement">10-25x â†—ï¸</td>
                    </tr>
                    <tr>
                        <td><strong>é˜Ÿåˆ—é•¿åº¦é™åˆ¶</strong></td>
                        <td class="current-system">1000æ¡</td>
                        <td class="upgraded-system">æ— é™åˆ¶</td>
                        <td class="improvement">âˆ â†—ï¸</td>
                    </tr>
                    <tr>
                        <td><strong>æ•°æ®æŒä¹…åŒ–</strong></td>
                        <td class="current-system">âŒ æ— </td>
                        <td class="upgraded-system">âœ… æœ‰</td>
                        <td class="improvement">é‡å¤§æ”¹è¿›</td>
                    </tr>
                    <tr>
                        <td><strong>æ•…éšœæ¢å¤</strong></td>
                        <td class="current-system">âŒ æ•°æ®ä¸¢å¤±</td>
                        <td class="upgraded-system">âœ… è‡ªåŠ¨æ¢å¤</td>
                        <td class="improvement">å¯é æ€§å¤§å¹…æå‡</td>
                    </tr>
                    <tr>
                        <td><strong>æ¨ªå‘æ‰©å±•èƒ½åŠ›</strong></td>
                        <td class="current-system">âŒ ä¸æ”¯æŒ</td>
                        <td class="upgraded-system">âœ… å®Œå…¨æ”¯æŒ</td>
                        <td class="improvement">æ¶æ„çº§æ”¹è¿›</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- æ ¸å¿ƒå®æ–½æ–¹æ¡ˆ -->
        <div class="section">
            <h2><span>ğŸ› ï¸</span> æ ¸å¿ƒå®æ–½æ–¹æ¡ˆ</h2>
            
            <div class="implementation-grid">
                <div class="impl-card priority-high">
                    <h4><span>ğŸ”´</span> ç¬¬ä¸€é˜¶æ®µï¼šRedisåŸºç¡€æ¶æ„ (1å‘¨)</h4>
                    <ul style="margin-left: 20px;">
                        <li><strong>æ›¿æ¢ç®€å•é˜Ÿåˆ—ï¼š</strong>SimpleQueue â†’ RedisStreamQueue</li>
                        <li><strong>ä¿æŒæ¥å£å…¼å®¹ï¼š</strong>ç°æœ‰ä»£ç æ— éœ€å¤§æ”¹</li>
                        <li><strong>é…ç½®ç®¡ç†ï¼š</strong>æ·»åŠ Redisè¿æ¥é…ç½®</li>
                        <li><strong>é”™è¯¯å¤„ç†ï¼š</strong>Redisæ•…éšœæ—¶å›é€€åˆ°å†…å­˜é˜Ÿåˆ—</li>
                        <li><strong>ç›‘æ§æŒ‡æ ‡ï¼š</strong>é˜Ÿåˆ—é•¿åº¦ã€å¤„ç†é€Ÿç‡ç›‘æ§</li>
                    </ul>
                </div>

                <div class="impl-card priority-high">
                    <h4><span>ğŸ”´</span> ç¬¬äºŒé˜¶æ®µï¼šå¼‚æ­¥ä¼˜åŒ– (1å‘¨)</h4>
                    <ul style="margin-left: 20px;">
                        <li><strong>å¼‚æ­¥åˆ†æå™¨ï¼š</strong>æ‰€æœ‰æ•…éšœåˆ†æå™¨å¼‚æ­¥åŒ–</li>
                        <li><strong>è¿æ¥æ± ï¼š</strong>Redisè¿æ¥æ± ä¼˜åŒ–</li>
                        <li><strong>æ‰¹å¤„ç†ï¼š</strong>æ•°æ®æ‰¹é‡å¤„ç†æå‡æ•ˆç‡</li>
                        <li><strong>èƒŒå‹æ§åˆ¶ï¼š</strong>æ™ºèƒ½æµé‡æ§åˆ¶</li>
                        <li><strong>æ€§èƒ½æµ‹è¯•ï¼š</strong>1000è½¦å¹¶å‘æµ‹è¯•</li>
                    </ul>
                </div>

                <div class="impl-card priority-medium">
                    <h4><span>ğŸŸ¡</span> ç¬¬ä¸‰é˜¶æ®µï¼šé«˜çº§ç‰¹æ€§ (1å‘¨)</h4>
                    <ul style="margin-left: 20px;">
                        <li><strong>æ¶ˆæ¯åˆ†åŒºï¼š</strong>æŒ‰è½¦è¾†IDåˆ†åŒºå¤„ç†</li>
                        <li><strong>ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼š</strong>ç´§æ€¥æ•…éšœä¼˜å…ˆå¤„ç†</li>
                        <li><strong>æ•°æ®å‹ç¼©ï¼š</strong>å‡å°‘ç½‘ç»œä¼ è¾“</li>
                        <li><strong>ç¼“å­˜ç­–ç•¥ï¼š</strong>çƒ­ç‚¹æ•°æ®Redisç¼“å­˜</li>
                        <li><strong>æ€§èƒ½è°ƒä¼˜ï¼š</strong>ç³»ç»Ÿå‚æ•°ç²¾ç»†è°ƒä¼˜</li>
                    </ul>
                </div>

                <div class="impl-card priority-medium">
                    <h4><span>ğŸŸ¡</span> ç¬¬å››é˜¶æ®µï¼šç”Ÿäº§éƒ¨ç½² (1å‘¨)</h4>
                    <ul style="margin-left: 20px;">
                        <li><strong>Dockeréƒ¨ç½²ï¼š</strong>å®¹å™¨åŒ–Redisé›†ç¾¤</li>
                        <li><strong>è´Ÿè½½å‡è¡¡ï¼š</strong>å¤šå®ä¾‹è´Ÿè½½åˆ†å‘</li>
                        <li><strong>ç›‘æ§å‘Šè­¦ï¼š</strong>Prometheus + Grafana</li>
                        <li><strong>è‡ªåŠ¨æ‰©ç¼©ï¼š</strong>åŸºäºè´Ÿè½½è‡ªåŠ¨æ‰©å±•</li>
                        <li><strong>ç”Ÿäº§éªŒè¯ï¼š</strong>å‹åŠ›æµ‹è¯•ä¸è°ƒä¼˜</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†æŠ€æœ¯å®ç° -->
        <div class="section">
            <h2><span>ğŸ’»</span> è¯¦ç»†æŠ€æœ¯å®ç°</h2>
            
            <h3><span>ğŸ“</span> 1. Redisé˜Ÿåˆ—æœåŠ¡å®ç°</h3>
            <div class="code-block">
                <div class="code-header">ğŸ“ backend/app/services/redis_async_queue.py</div>
#!/usr/bin/env python3
"""
Rediså¼‚æ­¥é˜Ÿåˆ—æœåŠ¡ - å®Œå…¨æ›¿ä»£SimpleQueue
åŸºäºRedis Streamså®ç°é«˜æ€§èƒ½æ¶ˆæ¯é˜Ÿåˆ—
"""
import asyncio
import redis.asyncio as redis
import json
import logging
from typing import Dict, Any, Callable, Optional
from datetime import datetime
import uuid

logger = logging.getLogger(__name__)

class RedisAsyncQueue:
    """åŸºäºRedis Streamsçš„é«˜æ€§èƒ½å¼‚æ­¥é˜Ÿåˆ—"""
    
    def __init__(self, redis_url: str = "redis://localhost:6379"):
        self.redis_url = redis_url
        self.redis_client: Optional[redis.Redis] = None
        self.consumer_group = "vtox_consumer_group"
        self.consumer_name = f"consumer_{uuid.uuid4().hex[:8]}"
        
        # é˜Ÿåˆ—é…ç½®
        self.streams = {
            'fault_data': 'fault_data_stream',
            'analysis_results': 'analysis_results_stream'
        }
        
        # æ¶ˆæ¯å¤„ç†å™¨
        self.handlers = {}
        
        # æ€§èƒ½ç»Ÿè®¡
        self.stats = {
            'total_sent': 0,
            'total_processed': 0,
            'processing_rate': 0,
            'last_processed_time': datetime.now()
        }
        
        # æ§åˆ¶æ ‡å¿—
        self.is_running = False
        self.consumer_tasks = []

    async def connect(self):
        """å»ºç«‹Redisè¿æ¥"""
        try:
            self.redis_client = redis.from_url(
                self.redis_url,
                encoding="utf-8",
                decode_responses=True,
                max_connections=20  # è¿æ¥æ± å¤§å°
            )
            
            # æµ‹è¯•è¿æ¥
            await self.redis_client.ping()
            
            # åˆ›å»ºæ¶ˆè´¹è€…ç»„
            for stream_name in self.streams.values():
                try:
                    await self.redis_client.xgroup_create(
                        stream_name, self.consumer_group, id='0', mkstream=True
                    )
                except redis.RedisError:
                    # æ¶ˆè´¹è€…ç»„å·²å­˜åœ¨
                    pass
            
            logger.info(f"âœ… Rediså¼‚æ­¥é˜Ÿåˆ—è¿æ¥æˆåŠŸ: {self.redis_url}")
            return True
            
        except Exception as e:
            logger.error(f"âŒ Redisè¿æ¥å¤±è´¥: {e}")
            return False

    async def send_message(self, topic: str, message: Dict[str, Any]) -> bool:
        """å‘é€æ¶ˆæ¯åˆ°Redis Stream"""
        if not self.redis_client:
            logger.warning("Rediså®¢æˆ·ç«¯æœªè¿æ¥")
            return False
        
        try:
            stream_name = self.streams.get(topic)
            if not stream_name:
                logger.warning(f"æœªçŸ¥é˜Ÿåˆ—ä¸»é¢˜: {topic}")
                return False
            
            # æ„å»ºæ¶ˆæ¯
            msg_data = {
                'timestamp': datetime.now().isoformat(),
                'data': json.dumps(message, ensure_ascii=False),
                'topic': topic,
                'producer': self.consumer_name
            }
            
            # å‘é€åˆ°Redis Stream
            msg_id = await self.redis_client.xadd(stream_name, msg_data)
            
            self.stats['total_sent'] += 1
            logger.debug(f"ğŸ“¤ æ¶ˆæ¯å·²å‘é€: {topic} -> {msg_id}")
            
            return True
            
        except Exception as e:
            logger.error(f"âŒ å‘é€æ¶ˆæ¯å¤±è´¥: {e}")
            return False

    def subscribe(self, topic: str, handler: Callable):
        """è®¢é˜…é˜Ÿåˆ—ä¸»é¢˜"""
        if topic not in self.streams:
            logger.warning(f"æœªçŸ¥é˜Ÿåˆ—ä¸»é¢˜: {topic}")
            return
        
        self.handlers[topic] = handler
        logger.info(f"ğŸ“¬ å·²è®¢é˜…é˜Ÿåˆ—ä¸»é¢˜: {topic}")

    async def start_consuming(self):
        """å¼€å§‹æ¶ˆè´¹æ‰€æœ‰é˜Ÿåˆ—"""
        if self.is_running:
            return
        
        if not await self.connect():
            logger.error("Redisè¿æ¥å¤±è´¥ï¼Œæ— æ³•å¯åŠ¨æ¶ˆè´¹è€…")
            return
        
        self.is_running = True
        logger.info("ğŸ”„ å¼€å§‹æ¶ˆè´¹Redisé˜Ÿåˆ—...")
        
        # ä¸ºæ¯ä¸ªæœ‰å¤„ç†å™¨çš„ä¸»é¢˜å¯åŠ¨æ¶ˆè´¹ä»»åŠ¡
        for topic, handler in self.handlers.items():
            stream_name = self.streams[topic]
            task = asyncio.create_task(
                self._consume_stream(stream_name, topic, handler)
            )
            self.consumer_tasks.append(task)
            logger.info(f"ğŸ¯ é˜Ÿåˆ— {topic} æ¶ˆè´¹è€…å·²å¯åŠ¨")
        
        # å¯åŠ¨æ€§èƒ½ç›‘æ§ä»»åŠ¡
        monitor_task = asyncio.create_task(self._monitor_performance())
        self.consumer_tasks.append(monitor_task)

    async def _consume_stream(self, stream_name: str, topic: str, handler: Callable):
        """æ¶ˆè´¹æŒ‡å®šRedis Stream"""
        while self.is_running:
            try:
                # ä»æµä¸­è¯»å–æ¶ˆæ¯
                streams = await self.redis_client.xreadgroup(
                    self.consumer_group,
                    self.consumer_name,
                    {stream_name: '>'},
                    count=10,  # æ‰¹é‡è¯»å–
                    block=1000  # é˜»å¡1ç§’
                )
                
                for stream, messages in streams:
                    for msg_id, fields in messages:
                        try:
                            # è§£ææ¶ˆæ¯æ•°æ®
                            data = json.loads(fields['data'])
                            
                            # è°ƒç”¨å¤„ç†å™¨
                            if asyncio.iscoroutinefunction(handler):
                                await handler(data)
                            else:
                                handler(data)
                            
                            # ç¡®è®¤æ¶ˆæ¯å¤„ç†å®Œæˆ
                            await self.redis_client.xack(
                                stream_name, self.consumer_group, msg_id
                            )
                            
                            self.stats['total_processed'] += 1
                            self.stats['last_processed_time'] = datetime.now()
                            
                        except Exception as e:
                            logger.error(f"å¤„ç†æ¶ˆæ¯å¤±è´¥: {e}")
                            # å¯ä»¥é€‰æ‹©å°†æ¶ˆæ¯æ”¾å…¥æ­»ä¿¡é˜Ÿåˆ—
                            
            except Exception as e:
                if self.is_running:
                    logger.error(f"æ¶ˆè´¹æµ {stream_name} æ—¶å‡ºé”™: {e}")
                    await asyncio.sleep(1)

    async def _monitor_performance(self):
        """æ€§èƒ½ç›‘æ§"""
        last_count = 0
        
        while self.is_running:
            await asyncio.sleep(10)
            
            current_count = self.stats['total_processed']
            rate = (current_count - last_count) / 10
            self.stats['processing_rate'] = rate
            last_count = current_count
            
            logger.info(f"ğŸ“Š é˜Ÿåˆ—æ€§èƒ½: {rate:.1f} msg/s, æ€»å¤„ç†: {current_count}")

    async def stop(self):
        """åœæ­¢æ¶ˆè´¹"""
        self.is_running = False
        
        # å–æ¶ˆæ‰€æœ‰æ¶ˆè´¹ä»»åŠ¡
        for task in self.consumer_tasks:
            task.cancel()
        
        # ç­‰å¾…ä»»åŠ¡å®Œæˆ
        if self.consumer_tasks:
            await asyncio.gather(*self.consumer_tasks, return_exceptions=True)
        
        # å…³é—­Redisè¿æ¥
        if self.redis_client:
            await self.redis_client.close()
        
        logger.info("ğŸ›‘ Rediså¼‚æ­¥é˜Ÿåˆ—å·²åœæ­¢")

# å…¨å±€å®ä¾‹
redis_async_queue = RedisAsyncQueue()

# å…¼å®¹æ€§æ˜ å°„ï¼ˆä¿æŒä¸ç°æœ‰ä»£ç å…¼å®¹ï¼‰
TOPICS = {
    'FAULT_DATA': 'fault_data',
    'ANALYSIS_RESULTS': 'analysis_results'
}
            </div>

            <h3><span>âš™ï¸</span> 2. é…ç½®æ–‡ä»¶å‡çº§</h3>
            <div class="code-block">
                <div class="code-header">ğŸ“ backend/app/core/redis_config.py</div>
"""
Redisé…ç½®æ¨¡å—
"""
from pydantic_settings import BaseSettings
import os

class RedisSettings(BaseSettings):
    # Redisè¿æ¥é…ç½®
    REDIS_URL: str = "redis://localhost:6379"
    REDIS_DB: int = 0
    REDIS_PASSWORD: str = ""
    
    # è¿æ¥æ± é…ç½®
    REDIS_MAX_CONNECTIONS: int = 20
    REDIS_SOCKET_TIMEOUT: int = 5
    REDIS_SOCKET_CONNECT_TIMEOUT: int = 5
    
    # é˜Ÿåˆ—é…ç½®
    REDIS_QUEUE_MAX_LENGTH: int = 100000
    REDIS_CONSUMER_BATCH_SIZE: int = 10
    REDIS_CONSUMER_BLOCK_TIME: int = 1000
    
    # æ€§èƒ½é…ç½®
    REDIS_ENABLE_COMPRESSION: bool = True
    REDIS_ENABLE_PERSISTENCE: bool = True
    
    # æ•…éšœè½¬ç§»é…ç½®
    FALLBACK_TO_MEMORY: bool = True
    MEMORY_QUEUE_MAX_SIZE: int = 1000

redis_settings = RedisSettings()

# Redisè¿æ¥å­—ç¬¦ä¸²æ„å»º
def get_redis_url() -> str:
    if redis_settings.REDIS_PASSWORD:
        return f"redis://:{redis_settings.REDIS_PASSWORD}@localhost:6379/{redis_settings.REDIS_DB}"
    return f"redis://localhost:6379/{redis_settings.REDIS_DB}"
            </div>

            <h3><span>ğŸ”„</span> 3. main.pyå‡çº§</h3>
            <div class="code-block">
                <div class="code-header">ğŸ“ backend/app/main.py (å…³é”®ä¿®æ”¹éƒ¨åˆ†)</div>
# åŸæœ‰å¯¼å…¥ä¿æŒä¸å˜...
from backend.app.services.redis_async_queue import redis_async_queue, TOPICS
from backend.app.services.simple_queue import simple_queue  # ä¿ç•™ä½œä¸ºå¤‡ç”¨
from backend.app.core.redis_config import redis_settings

@asynccontextmanager
async def lifespan(app: FastAPI):
    # åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºæ•°æ®åº“è¡¨
    logger.info("åˆ›å»ºæ•°æ®åº“è¡¨...")
    logger.info("æ•°æ®åº“è¡¨åˆ›å»ºå®Œæˆã€‚")
    
    # æ£€æŸ¥å’Œè®¾ç½®API Key
    await check_and_setup_api_key()
    
    # å°è¯•å¯åŠ¨Rediså¼‚æ­¥é˜Ÿåˆ—æœåŠ¡
    logger.info("å°è¯•å¯åŠ¨Rediså¼‚æ­¥é˜Ÿåˆ—æœåŠ¡...")
    redis_started = False
    
    try:
        # è®¾ç½®Redisé˜Ÿåˆ—æ¶ˆæ¯å¤„ç†å™¨
        redis_async_queue.subscribe(TOPICS['FAULT_DATA'], handle_fault_data_from_redis)
        redis_async_queue.subscribe(TOPICS['ANALYSIS_RESULTS'], handle_analysis_result_from_redis)
        
        # å¯åŠ¨Redisé˜Ÿåˆ—æ¶ˆè´¹è€…
        await redis_async_queue.start_consuming()
        redis_started = True
        logger.info("âœ… Rediså¼‚æ­¥é˜Ÿåˆ—æœåŠ¡å¯åŠ¨å®Œæˆ")
        
    except Exception as e:
        logger.error(f"Rediså¼‚æ­¥é˜Ÿåˆ—å¯åŠ¨å¤±è´¥: {e}")
        
        # æ•…éšœè½¬ç§»ï¼šå›é€€åˆ°å†…å­˜é˜Ÿåˆ—
        if redis_settings.FALLBACK_TO_MEMORY:
            logger.info("å¯åŠ¨å†…å­˜é˜Ÿåˆ—ä½œä¸ºå¤‡ç”¨...")
            try:
                simple_queue.subscribe(TOPICS['FAULT_DATA'], handle_fault_data_from_redis)
                simple_queue.subscribe(TOPICS['ANALYSIS_RESULTS'], handle_analysis_result_from_redis)
                asyncio.create_task(simple_queue.start_consuming())
                logger.info("âœ… å¤‡ç”¨å†…å­˜é˜Ÿåˆ—æœåŠ¡å¯åŠ¨å®Œæˆ")
            except Exception as e2:
                logger.error(f"å¤‡ç”¨å†…å­˜é˜Ÿåˆ—å¯åŠ¨ä¹Ÿå¤±è´¥: {e2}")
    
    # å°†é˜Ÿåˆ—æœåŠ¡è®¾ç½®ä¸ºå…¨å±€å¯è®¿é—®
    app.state.queue_service = redis_async_queue if redis_started else simple_queue
    app.state.queue_type = "redis_async" if redis_started else "simple_memory"
    
    logger.info("Application startup complete.")
    yield
    
    # å…³é—­æ—¶æ‰§è¡Œçš„ä»£ç 
    logger.info("æ­£åœ¨å…³é—­åº”ç”¨...")
    
    # åœæ­¢é˜Ÿåˆ—æœåŠ¡
    if redis_started:
        await redis_async_queue.stop()
    else:
        await simple_queue.stop()
    
    # æ¸…ç†WebSocketèµ„æº
    from backend.app.websockets.realtime_diagnosis import shutdown_event
    await shutdown_event()

# æ ¹è·¯ç”±æ›´æ–°
@app.get("/", summary="APIæ ¹ç›®å½•")
async def root():
    """APIæ ¹è·¯å¾„"""
    return {
        "message": "åŒé—´çŸ­è·¯æ•…éšœè¯Šæ–­ç³»ç»ŸAPI - Rediså‡çº§ç‰ˆ",
        "status": "è¿è¡Œä¸­",
        "version": "2.0.0",
        "queue_type": getattr(app.state, 'queue_type', 'unknown'),
        "performance_mode": "é«˜å¹¶å‘Rediså¼‚æ­¥" if app.state.queue_type == "redis_async" else "åŸºç¡€å†…å­˜é˜Ÿåˆ—"
    }
            </div>
        </div>

        <!-- æ€§èƒ½é¢„æœŸ -->
        <div class="section">
            <h2><span>ğŸ“ˆ</span> æ€§èƒ½é¢„æœŸä¸æµ‹è¯•æŒ‡æ ‡</h2>
            
            <div class="performance-metrics">
                <div class="metric-card">
                    <h4>å¹¶å‘è½¦è¾†æ•°</h4>
                    <div class="metric-number">1000+</div>
                    <div class="metric-improvement">ä»100è½¦æå‡</div>
                </div>
                <div class="metric-card">
                    <h4>æ¶ˆæ¯å¤„ç†é€Ÿç‡</h4>
                    <div class="metric-number">50K/s</div>
                    <div class="metric-improvement">ä»1K/sæå‡</div>
                </div>
                <div class="metric-card">
                    <h4>å¹³å‡å“åº”æ—¶é—´</h4>
                    <div class="metric-number">15ms</div>
                    <div class="metric-improvement">ä»200msé™ä½</div>
                </div>
                <div class="metric-card">
                    <h4>ç³»ç»Ÿå¯ç”¨æ€§</h4>
                    <div class="metric-number">99.9%</div>
                    <div class="metric-improvement">é«˜å¯ç”¨ä¿éšœ</div>
                </div>
                <div class="metric-card">
                    <h4>æ•…éšœæ¢å¤æ—¶é—´</h4>
                    <div class="metric-number">2s</div>
                    <div class="metric-improvement">è‡ªåŠ¨æ•…éšœè½¬ç§»</div>
                </div>
                <div class="metric-card">
                    <h4>æ•°æ®ä¸ä¸¢å¤±</h4>
                    <div class="metric-number">100%</div>
                    <div class="metric-improvement">RedisæŒä¹…åŒ–</div>
                </div>
            </div>

            <h3><span>ğŸ§ª</span> å‹åŠ›æµ‹è¯•è„šæœ¬</h3>
            <div class="code-block">
                <div class="code-header">ğŸ“ tests/performance_test.py</div>
#!/usr/bin/env python3
"""
Rediså¼‚æ­¥é˜Ÿåˆ—æ€§èƒ½æµ‹è¯•
æ¨¡æ‹Ÿ1000è½¦é«˜é¢‘æ•°æ®å‘é€
"""
import asyncio
import aiohttp
import time
import random
from typing import List
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class VehicleSimulator:
    """è½¦è¾†æ•°æ®æ¨¡æ‹Ÿå™¨"""
    
    def __init__(self, base_url: str = "http://localhost:8000"):
        self.base_url = base_url
        self.stats = {
            'sent': 0,
            'errors': 0,
            'start_time': time.time()
        }

    async def simulate_vehicle(self, vehicle_id: int, session: aiohttp.ClientSession):
        """æ¨¡æ‹Ÿå•ä¸ªè½¦è¾†å‘é€æ•°æ®"""
        while True:
            try:
                # ç”Ÿæˆæ•…éšœæ•°æ®
                data = {
                    "vehicle_id": f"TEST_CAR_{vehicle_id:06d}",
                    "timestamp": time.time(),
                    "fault_type": "broken_bar",
                    "fault_data": {
                        "Ia": random.uniform(-10, 10),
                        "Ib": random.uniform(-10, 10), 
                        "Ic": random.uniform(-10, 10),
                        "speed": random.uniform(0, 3000),
                        "temperature": random.uniform(60, 90)
                    }
                }
                
                # å‘é€æ•°æ®
                async with session.post(
                    f"{self.base_url}/api/fault_data",
                    json=data,
                    timeout=aiohttp.ClientTimeout(total=5)
                ) as response:
                    if response.status == 200:
                        self.stats['sent'] += 1
                    else:
                        self.stats['errors'] += 1
                
                # æ§åˆ¶å‘é€é¢‘ç‡ (50Hz per vehicle)
                await asyncio.sleep(0.02)
                
            except Exception as e:
                self.stats['errors'] += 1
                await asyncio.sleep(0.1)

    async def run_test(self, num_vehicles: int = 1000, duration: int = 60):
        """è¿è¡Œæ€§èƒ½æµ‹è¯•"""
        logger.info(f"ğŸš€ å¼€å§‹æ€§èƒ½æµ‹è¯•: {num_vehicles}è½¦ Ã— 50Hz Ã— {duration}ç§’")
        
        # åˆ›å»ºHTTPè¿æ¥æ± 
        connector = aiohttp.TCPConnector(
            limit=500,
            limit_per_host=100,
            keepalive_timeout=30
        )
        
        async with aiohttp.ClientSession(connector=connector) as session:
            # åˆ›å»ºè½¦è¾†æ¨¡æ‹Ÿä»»åŠ¡
            tasks = []
            for vehicle_id in range(num_vehicles):
                task = asyncio.create_task(
                    self.simulate_vehicle(vehicle_id, session)
                )
                tasks.append(task)
                
                # åˆ†æ‰¹å¯åŠ¨ï¼Œé¿å…ç¬é—´å‹åŠ›è¿‡å¤§
                if len(tasks) % 100 == 0:
                    await asyncio.sleep(0.1)
            
            logger.info(f"âœ… {num_vehicles}ä¸ªè½¦è¾†æ¨¡æ‹Ÿå™¨å·²å¯åŠ¨")
            
            # è¿è¡ŒæŒ‡å®šæ—¶é—´
            await asyncio.sleep(duration)
            
            # åœæ­¢æ‰€æœ‰ä»»åŠ¡
            for task in tasks:
                task.cancel()
            
            await asyncio.gather(*tasks, return_exceptions=True)
        
        # è¾“å‡ºæµ‹è¯•ç»“æœ
        elapsed = time.time() - self.stats['start_time']
        total_rate = self.stats['sent'] / elapsed
        
        logger.info(f"ğŸ“Š æµ‹è¯•å®Œæˆ:")
        logger.info(f"   å‘é€æˆåŠŸ: {self.stats['sent']} æ¡")
        logger.info(f"   å‘é€å¤±è´¥: {self.stats['errors']} æ¡")
        logger.info(f"   æ€»é€Ÿç‡: {total_rate:.1f} msg/s")
        logger.info(f"   å•è½¦é€Ÿç‡: {total_rate/num_vehicles:.1f} msg/s")
        logger.info(f"   æˆåŠŸç‡: {self.stats['sent']/(self.stats['sent']+self.stats['errors'])*100:.1f}%")

if __name__ == "__main__":
    simulator = VehicleSimulator()
    asyncio.run(simulator.run_test(num_vehicles=1000, duration=60))
            </div>
        </div>

        <!-- å®æ–½æ—¶é—´è¡¨ -->
        <div class="section">
            <h2><span>ğŸ“…</span> å®æ–½æ—¶é—´è¡¨</h2>
            
            <div class="timeline">
                <h3 style="color: white; text-align: center; margin-bottom: 25px;">ğŸš€ 4å‘¨å®Œæ•´å‡çº§è®¡åˆ’</h3>
                
                <div class="timeline-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>ç¬¬1å‘¨ï¼šRedisåŸºç¡€æ¶æ„</h4>
                        <p><strong>ç›®æ ‡ï¼š</strong>Redisé˜Ÿåˆ—æ›¿ä»£SimpleQueueï¼Œä¿æŒåŠŸèƒ½å…¼å®¹</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>å®‰è£…RedisæœåŠ¡å™¨ (2å°æ—¶)</li>
                            <li>å®ç°RedisAsyncQueueç±» (1å¤©)</li>
                            <li>æ›´æ–°é…ç½®æ–‡ä»¶ (0.5å¤©)</li>
                            <li>ä¿®æ”¹main.pyå¯åŠ¨é€»è¾‘ (0.5å¤©)</li>
                            <li>æ·»åŠ æ•…éšœè½¬ç§»æœºåˆ¶ (1å¤©)</li>
                            <li>åŸºç¡€åŠŸèƒ½æµ‹è¯• (2å¤©)</li>
                        </ul>
                    </div>
                </div>
                
                <div class="timeline-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>ç¬¬2å‘¨ï¼šå¼‚æ­¥ä¼˜åŒ–</h4>
                        <p><strong>ç›®æ ‡ï¼š</strong>å…¨é¢å¼‚æ­¥åŒ–ï¼Œå¤§å¹…æå‡æ€§èƒ½</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>å¼‚æ­¥åŒ–æ‰€æœ‰æ•…éšœåˆ†æå™¨ (2å¤©)</li>
                            <li>ä¼˜åŒ–Redisè¿æ¥æ±  (1å¤©)</li>
                            <li>å®ç°æ‰¹å¤„ç†æœºåˆ¶ (1å¤©)</li>
                            <li>æ·»åŠ èƒŒå‹æ§åˆ¶ (1å¤©)</li>
                            <li>100è½¦å¹¶å‘æµ‹è¯• (2å¤©)</li>
                        </ul>
                    </div>
                </div>
                
                <div class="timeline-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>ç¬¬3å‘¨ï¼šé«˜çº§ç‰¹æ€§</h4>
                        <p><strong>ç›®æ ‡ï¼š</strong>å®ç°é«˜çº§åŠŸèƒ½ï¼Œè¾¾åˆ°ç”Ÿäº§çº§åˆ«</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>æ¶ˆæ¯åˆ†åŒºç­–ç•¥ (1.5å¤©)</li>
                            <li>ä¼˜å…ˆçº§é˜Ÿåˆ— (1.5å¤©)</li>
                            <li>æ•°æ®å‹ç¼© (1å¤©)</li>
                            <li>ç¼“å­˜ç­–ç•¥ (1å¤©)</li>
                            <li>1000è½¦å‹åŠ›æµ‹è¯• (2å¤©)</li>
                        </ul>
                    </div>
                </div>
                
                <div class="timeline-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h4>ç¬¬4å‘¨ï¼šç”Ÿäº§éƒ¨ç½²</h4>
                        <p><strong>ç›®æ ‡ï¼š</strong>ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼Œç›‘æ§å‘Šè­¦å®Œå–„</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>DockeråŒ–éƒ¨ç½² (1.5å¤©)</li>
                            <li>è´Ÿè½½å‡è¡¡é…ç½® (1å¤©)</li>
                            <li>ç›‘æ§å‘Šè­¦ç³»ç»Ÿ (1.5å¤©)</li>
                            <li>ç”Ÿäº§ç¯å¢ƒéªŒè¯ (2å¤©)</li>
                            <li>æ–‡æ¡£ç¼–å†™ (1å¤©)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- é£é™©åˆ†æ -->
        <div class="section">
            <h2><span>âš ï¸</span> é£é™©åˆ†æä¸åº”å¯¹ç­–ç•¥</h2>
            
            <div class="risk-analysis">
                <h3 style="color: white; text-align: center; margin-bottom: 25px;">ğŸ›¡ï¸ é£é™©ç®¡æ§</h3>
                
                <div class="risk-grid">
                    <div class="risk-item">
                        <h4>ğŸ”´ é«˜é£é™©ï¼šRedisæœåŠ¡æ•…éšœ</h4>
                        <p><strong>å½±å“ï¼š</strong>é˜Ÿåˆ—æœåŠ¡å®Œå…¨ä¸­æ–­</p>
                        <p><strong>åº”å¯¹ï¼š</strong>è‡ªåŠ¨æ•…éšœè½¬ç§»åˆ°å†…å­˜é˜Ÿåˆ—</p>
                        <p><strong>æ¢å¤æ—¶é—´ï¼š</strong>< 2ç§’</p>
                    </div>
                    <div class="risk-item">
                        <h4>ğŸŸ¡ ä¸­é£é™©ï¼šå†…å­˜ä¸è¶³</h4>
                        <p><strong>å½±å“ï¼š</strong>é˜Ÿåˆ—æ€§èƒ½ä¸‹é™</p>
                        <p><strong>åº”å¯¹ï¼š</strong>æ™ºèƒ½èƒŒå‹æ§åˆ¶ + æ•°æ®å‹ç¼©</p>
                        <p><strong>ç›‘æ§ï¼š</strong>å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦</p>
                    </div>
                    <div class="risk-item">
                        <h4>ğŸŸ¡ ä¸­é£é™©ï¼šç½‘ç»œå»¶è¿Ÿ</h4>
                        <p><strong>å½±å“ï¼š</strong>å“åº”æ—¶é—´å¢åŠ </p>
                        <p><strong>åº”å¯¹ï¼š</strong>è¿æ¥æ± ä¼˜åŒ– + æœ¬åœ°ç¼“å­˜</p>
                        <p><strong>æŒ‡æ ‡ï¼š</strong>P99å»¶è¿Ÿ < 50ms</p>
                    </div>
                    <div class="risk-item">
                        <h4>ğŸŸ¢ ä½é£é™©ï¼šé…ç½®é”™è¯¯</h4>
                        <p><strong>å½±å“ï¼š</strong>åŠŸèƒ½å¼‚å¸¸</p>
                        <p><strong>åº”å¯¹ï¼š</strong>é…ç½®éªŒè¯ + é»˜è®¤å€¼</p>
                        <p><strong>é¢„é˜²ï¼š</strong>ç¯å¢ƒå˜é‡æ£€æŸ¥</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- éƒ¨ç½²é…ç½® -->
        <div class="section">
            <h2><span>ğŸ³</span> Dockeréƒ¨ç½²é…ç½®</h2>
            
            <h3><span>ğŸ“‹</span> Redisé›†ç¾¤éƒ¨ç½²</h3>
            <div class="code-block">
                <div class="code-header">ğŸ“ docker-compose-redis-cluster.yml</div>
version: '3.8'

services:
  redis-master:
    image: redis:7-alpine
    container_name: vtox-redis-master
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - vtox-network
    restart: unless-stopped

  redis-replica:
    image: redis:7-alpine
    container_name: vtox-redis-replica
    ports:
      - "6380:6379"
    command: redis-server --replicaof redis-master 6379 --appendonly yes
    depends_on:
      - redis-master
    networks:
      - vtox-network
    restart: unless-stopped

  redis-sentinel:
    image: redis:7-alpine
    container_name: vtox-redis-sentinel
    ports:
      - "26379:26379"
    command: redis-sentinel /etc/redis/sentinel.conf
    volumes:
      - ./sentinel.conf:/etc/redis/sentinel.conf
    depends_on:
      - redis-master
      - redis-replica
    networks:
      - vtox-network
    restart: unless-stopped

  # VTOXåç«¯æœåŠ¡
  vtox-backend:
    build: ./backend
    container_name: vtox-backend
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=redis://redis-master:6379
      - REDIS_SENTINEL_URL=redis://redis-sentinel:26379
    depends_on:
      - redis-master
    networks:
      - vtox-network
    restart: unless-stopped

volumes:
  redis_data:

networks:
  vtox-network:
    driver: bridge
            </div>

            <h3><span>âš™ï¸</span> ç”Ÿäº§ç¯å¢ƒé…ç½®</h3>
            <div class="config-panel">
# Redisç”Ÿäº§é…ç½®
REDIS_URL=redis://prod-redis-cluster:6379
REDIS_MAX_CONNECTIONS=50
REDIS_SOCKET_TIMEOUT=10
REDIS_QUEUE_MAX_LENGTH=1000000
REDIS_CONSUMER_BATCH_SIZE=50

# æ€§èƒ½ä¼˜åŒ–
REDIS_ENABLE_COMPRESSION=true
REDIS_ENABLE_PERSISTENCE=true
FALLBACK_TO_MEMORY=true

# ç›‘æ§é…ç½®
PROMETHEUS_ENABLED=true
GRAFANA_DASHBOARD=true
LOG_LEVEL=INFO
            </div>
        </div>

        <!-- æ€»ç»“ -->
        <div class="section">
            <h2><span>ğŸ¯</span> å‡çº§æ–¹æ¡ˆæ€»ç»“</h2>
            
            <div class="upgrade-highlight">
                <h3>âœ… æ ¸å¿ƒæ”¶ç›Š</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div>
                        <strong>ğŸš€ æ€§èƒ½é£è·ƒ</strong><br>
                        å¤„ç†èƒ½åŠ›æå‡50å€ï¼Œæ”¯æŒ1000+è½¦è¾†
                    </div>
                    <div>
                        <strong>ğŸ”’ æ•°æ®å®‰å…¨</strong><br>
                        RedisæŒä¹…åŒ–ï¼Œæ•…éšœè‡ªåŠ¨æ¢å¤
                    </div>
                    <div>
                        <strong>ğŸ“ˆ å¯æ‰©å±•æ€§</strong><br>
                        æ°´å¹³æ‰©å±•ï¼Œæ”¯æŒé›†ç¾¤éƒ¨ç½²
                    </div>
                    <div>
                        <strong>ğŸ›¡ï¸ é«˜å¯ç”¨</strong><br>
                        æ•…éšœè½¬ç§»ï¼Œ99.9%å¯ç”¨æ€§
                    </div>
                </div>
            </div>

            <div class="performance-metrics">
                <div class="metric-card">
                    <h4>æŠ•èµ„å›æŠ¥</h4>
                    <div class="metric-number">300%</div>
                    <p>æ€§èƒ½æå‡ vs å¼€å‘æˆæœ¬</p>
                </div>
                <div class="metric-card">
                    <h4>å®æ–½æ—¶é—´</h4>
                    <div class="metric-number">4å‘¨</div>
                    <p>å®Œæ•´å‡çº§å‘¨æœŸ</p>
                </div>
                <div class="metric-card">
                    <h4>æŠ€æœ¯å€ºåŠ¡</h4>
                    <div class="metric-number">0</div>
                    <p>å®Œå…¨å‘åå…¼å®¹</p>
                </div>
                <div class="metric-card">
                    <h4>ç»´æŠ¤æˆæœ¬</h4>
                    <div class="metric-number">-50%</div>
                    <p>è‡ªåŠ¨åŒ–è¿ç»´é™ä½</p>
                </div>
            </div>
        </div>

        <!-- é¡µè„š -->
        <div style="background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 30px; text-align: center; margin-top: 30px;">
            <p><strong>ğŸš€ VTOXè½¦è”ç½‘æ•…éšœè¯Šæ–­ç³»ç»Ÿ - Redis+Pythonå¼‚æ­¥å‡çº§æ–¹æ¡ˆ</strong></p>
            <p>ç°ä»£åŒ–é«˜æ€§èƒ½æ¶æ„ï¼Œæ”¯æ’‘å¤§è§„æ¨¡è½¦è”ç½‘å®æ—¶æ•…éšœè¯Šæ–­</p>
            <p style="color: #e74c3c; margin-top: 15px;">
                ğŸ“§ æŠ€æœ¯æ”¯æŒ: tech@vtox.dev | ğŸ”§ å®æ–½é¡¾é—®: upgrade@vtox.dev<br>
                ğŸŒŸ å‡çº§å®Œæˆåï¼Œæ‚¨çš„ç³»ç»Ÿå°†å…·å¤‡ä¼ä¸šçº§é«˜å¹¶å‘å¤„ç†èƒ½åŠ›ï¼
            </p>
        </div>
    </div>
</body>
</html> 