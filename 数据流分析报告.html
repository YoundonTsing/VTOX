<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据流分析报告 - 车联网故障诊断系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
            position: relative;
        }
        
        .section h2::before {
            content: '';
            position: absolute;
            left: 0;
            bottom: -3px;
            width: 50px;
            height: 3px;
            background: #e74c3c;
        }
        
        .section h3 {
            color: #34495e;
            font-size: 1.4em;
            margin: 25px 0 15px;
            padding-left: 20px;
            border-left: 4px solid #3498db;
        }
        
        .flow-diagram {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin: 30px 0;
        }
        
        .flow-step {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border-left: 5px solid #3498db;
            transition: transform 0.3s ease;
        }
        
        .flow-step:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        .flow-number {
            background: #3498db;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .flow-content {
            flex: 1;
        }
        
        .flow-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .flow-description {
            color: #666;
            font-size: 1em;
        }
        
        .arrow-down {
            text-align: center;
            font-size: 2em;
            color: #3498db;
            margin: 10px 0;
        }
        
        .data-structure {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .comparison-table th {
            background: #3498db;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }
        
        .comparison-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        
        .comparison-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .comparison-table tr:hover {
            background: #e3f2fd;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-match {
            background: #d4edda;
            color: #155724;
        }
        
        .status-partial {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-mismatch {
            background: #f8d7da;
            color: #721c24;
        }
        
        .highlight-box {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #f39c12;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 5px solid #f39c12;
        }
        
        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 5px solid #27ae60;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .analysis-card {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid #3498db;
        }
        
        .analysis-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .analysis-card ul {
            list-style: none;
            padding-left: 0;
        }
        
        .analysis-card li {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .analysis-card li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: #27ae60;
            font-weight: bold;
        }
        
        .mismatch::before {
            content: '✗';
            color: #e74c3c;
        }
        
        .partial::before {
            content: '◐';
            color: #f39c12;
        }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部信息 -->
        <div class="header">
            <h1>🔍 数据流分析报告</h1>
            <div class="subtitle">车联网故障诊断系统 - 数据源到前端显示的完整链路分析</div>
        </div>

        <!-- 数据流概览 -->
        <div class="section">
            <h2>📊 数据流链路概览</h2>
            
            <div class="flow-diagram">
                <div class="flow-step">
                    <div class="flow-number">1</div>
                    <div class="flow-content">
                        <div class="flow-title">数据源（模拟器）</div>
                        <div class="flow-description">
                            生成模拟的电机故障数据，包括三相电流、振动信号等原始传感器数据
                        </div>
                    </div>
                </div>
                
                <div class="arrow-down">↓</div>
                
                <div class="flow-step">
                    <div class="flow-number">2</div>
                    <div class="flow-content">
                        <div class="flow-title">WebSocket 传输</div>
                        <div class="flow-description">
                            通过WebSocket协议将原始数据传输到后端处理系统
                        </div>
                    </div>
                </div>
                
                <div class="arrow-down">↓</div>
                
                <div class="flow-step">
                    <div class="flow-number">3</div>
                    <div class="flow-content">
                        <div class="flow-title">后端分析处理</div>
                        <div class="flow-description">
                            后端分析器对原始数据进行特征提取、故障检测和评分计算
                        </div>
                    </div>
                </div>
                
                <div class="arrow-down">↓</div>
                
                <div class="flow-step">
                    <div class="flow-number">4</div>
                    <div class="flow-content">
                        <div class="flow-title">分析结果传输</div>
                        <div class="flow-description">
                            将处理后的分析结果通过WebSocket发送到前端
                        </div>
                    </div>
                </div>
                
                <div class="arrow-down">↓</div>
                
                <div class="flow-step">
                    <div class="flow-number">5</div>
                    <div class="flow-content">
                        <div class="flow-title">前端数据处理</div>
                        <div class="flow-description">
                            前端接收分析结果，经过数据管理器处理和优化
                        </div>
                    </div>
                </div>
                
                <div class="arrow-down">↓</div>
                
                <div class="flow-step">
                    <div class="flow-number">6</div>
                    <div class="flow-content">
                        <div class="flow-title">图表可视化</div>
                        <div class="flow-description">
                            将处理后的数据渲染为时域图、频谱图、特征趋势图等可视化图表
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据结构详细分析 -->
        <div class="section">
            <h2>🔧 数据结构详细分析</h2>
            
            <h3>1. 数据源产生的数据结构</h3>
            <div class="data-structure">
// 数据模拟器输出格式（以匝间短路故障为例）
{
  "timestamp": "2024-12-01T10:30:00.000Z",
  "connection_id": "simple-simulator-turn_fault",
  "data": [
    {
      "时间": 0.0001,
      "Ia": 10.5,      // A相电流
      "Ib": -5.2,      // B相电流  
      "Ic": -5.3,      // C相电流
      "功率": 2200.5
    },
    // ... 更多数据点（800个）
  ],
  "sampling_rate": 8000,
  "batch_size": 800,
  "fault_type": "turn_fault",
  "fault_active": true,
  "fault_severity": 0.1
}
            </div>

            <h3>2. 后端分析器输出的数据结构</h3>
            <div class="data-structure">
// 后端分析器输出格式（匝间短路分析器）
{
  "timestamp": "2024-12-01T10:30:01.000Z",
  "status": "warning",           // "normal" | "warning" | "fault"
  "score": 0.25,                 // 故障评分 0-1
  "features": {
    "current_imbalance": 0.15,    // 电流不平衡度
    "third_harmonic_ratio": 0.08, // 三次谐波比例
    "negative_sequence_ratio": 0.15, // 负序分量比例
    "fault_severity": 0.3
  },
  "time_series": {
    "time": [0.0001, 0.0002, ...], // 时间轴（采样后）
    "values_a": [10.5, 10.3, ...], // A相电流
    "values_b": [-5.2, -5.1, ...], // B相电流
    "values_c": [-5.3, -5.4, ...]  // C相电流
  },
  "frequency_spectrum": {
    "frequency": [0, 50, 100, ...], // 频率轴
    "amplitude_a": [0.1, 10.5, ...], // A相频谱
    "amplitude_b": [0.1, 5.2, ...],  // B相频谱
    "amplitude_c": [0.1, 5.3, ...]   // C相频谱
  },
  "diagnosis_conclusion": "检测到轻微匝间短路故障特征...",
  "suggestions": ["增加监测频率", "检查电机绝缘状况"]
}
            </div>

            <h3>3. 后端添加的元数据结构</h3>
            <div class="data-structure">
// WebSocket管理器添加的元数据
{
  // ... 分析器输出的所有字段
  "fault_type": "turn_fault",
  "data_source": "simple-simulator-turn_fault",
  "timestamp": "2024-12-01T10:30:01.000Z", // 重新设置为处理时间
  "queue_size": 5,
  "system_stats": {
    "sampling_rate": 8000,
    "processing_rate": 10,
    "queue_usage": 0.05
  }
}
            </div>

            <h3>4. 前端接收和处理的数据结构</h3>
            <div class="data-structure">
// 前端 DataManager 处理后的数据结构
{
  "latest": {
    // 最新的分析结果（经过压缩优化）
    "timestamp": "2024-12-01T10:30:01.000Z",
    "status": "warning",
    "score": 0.25,
    "features": { ... },
    "time_series": {
      "time": [...],        // 压缩到50个点
      "values_a": [...],    // 压缩到50个点
      "values_b": [...],
      "values_c": [...]
    },
    "frequency_spectrum": {
      "frequency": [...],   // 压缩到30个点
      "amplitude_a": [...], // 压缩到30个点
      "amplitude_b": [...],
      "amplitude_c": [...]
    }
  },
  "history": [
    // 历史记录（最多10条）
    { ... }, { ... }, ...
  ],
  "timeSeries": {
    "labels": ["10:30:01", "10:30:02", ...],
    "datasets": [
      {
        "label": "A相电流",
        "data": [10.5, 10.3, ...],
        "borderColor": "#409EFF"
      }
    ]
  },
  "spectrum": { ... },      // Chart.js格式的频谱数据
  "featureTrend": { ... },  // Chart.js格式的特征趋势
  "historyChart": { ... }   // Chart.js格式的历史趋势
}
            </div>
        </div>

        <!-- 对应关系分析 -->
        <div class="section">
            <h2>🔗 数据类型与结构对应关系分析</h2>
            
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>数据字段</th>
                        <th>数据源格式</th>
                        <th>后端输出格式</th>
                        <th>前端接收格式</th>
                        <th>对应状态</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>基础元数据</strong></td>
                        <td>timestamp, connection_id, fault_type</td>
                        <td>timestamp, fault_type, data_source</td>
                        <td>timestamp, fault_type</td>
                        <td><span class="status-indicator status-match">完全匹配</span></td>
                    </tr>
                    <tr>
                        <td><strong>故障评分</strong></td>
                        <td>fault_severity (0-1)</td>
                        <td>score (0-1), status (string)</td>
                        <td>score (0-1), status (string)</td>
                        <td><span class="status-indicator status-match">完全匹配</span></td>
                    </tr>
                    <tr>
                        <td><strong>特征参数</strong></td>
                        <td>不包含（原始数据）</td>
                        <td>features 对象（计算结果）</td>
                        <td>features 对象（直接使用）</td>
                        <td><span class="status-indicator status-match">完全匹配</span></td>
                    </tr>
                    <tr>
                        <td><strong>时域数据</strong></td>
                        <td>data 数组（800点）</td>
                        <td>time_series 对象（200点采样）</td>
                        <td>timeSeries Chart.js格式（50点压缩）</td>
                        <td><span class="status-indicator status-partial">部分匹配</span></td>
                    </tr>
                    <tr>
                        <td><strong>频域数据</strong></td>
                        <td>不包含（需计算）</td>
                        <td>frequency_spectrum 对象（200点采样）</td>
                        <td>spectrum Chart.js格式（30点压缩）</td>
                        <td><span class="status-indicator status-partial">部分匹配</span></td>
                    </tr>
                    <tr>
                        <td><strong>历史数据</strong></td>
                        <td>不包含</td>
                        <td>不包含（实时生成）</td>
                        <td>history 数组（10条记录）</td>
                        <td><span class="status-indicator status-match">完全匹配</span></td>
                    </tr>
                    <tr>
                        <td><strong>诊断结论</strong></td>
                        <td>不包含</td>
                        <td>diagnosis_conclusion, suggestions</td>
                        <td>不直接使用（可扩展）</td>
                        <td><span class="status-indicator status-partial">部分匹配</span></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 通信方式分析 -->
        <div class="section">
            <h2>🌐 通信方式分析</h2>
            
            <div class="analysis-grid">
                <div class="analysis-card">
                    <h4>数据源 → 后端</h4>
                    <ul>
                        <li>协议：WebSocket (ws://localhost:8000/ws/datasource)</li>
                        <li>数据格式：JSON字符串</li>
                        <li>传输频率：实时流式传输</li>
                        <li>数据量：800点/批次，约8KB/消息</li>
                        <li>确认机制：每10个数据包确认一次</li>
                    </ul>
                </div>
                
                <div class="analysis-card">
                    <h4>后端 → 前端</h4>
                    <ul>
                        <li>协议：WebSocket (ws://localhost:8000/ws/frontend)</li>
                        <li>数据格式：JSON字符串</li>
                        <li>传输频率：处理完成后即时发送</li>
                        <li>数据量：200点采样，约3KB/消息</li>
                        <li>广播机制：同时发送给所有连接的前端</li>
                    </ul>
                </div>
                
                <div class="analysis-card">
                    <h4>前端内部处理</h4>
                    <ul>
                        <li>接收：WebSocket消息事件监听</li>
                        <li>缓冲：20条消息缓冲区</li>
                        <li>处理：批量处理（10条/批次）</li>
                        <li>压缩：智能采样到30-50点</li>
                        <li>渲染：Chart.js增量更新</li>
                    </ul>
                </div>
                
                <div class="analysis-card">
                    <h4>性能优化机制</h4>
                    <ul>
                        <li>防抖：200ms内重复更新合并</li>
                        <li>采样：自适应数据点减少</li>
                        <li>缓存：Map结构数据池管理</li>
                        <li>清理：50MB内存阈值自动清理</li>
                        <li>监控：实时性能指标追踪</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 问题发现与建议 -->
        <div class="section">
            <h2>⚠️ 问题发现与优化建议</h2>
            
            <h3>发现的问题</h3>
            
            <div class="warning-box">
                <h4>🔴 数据压缩层级过多</h4>
                <p><strong>问题：</strong>数据从原始800点 → 后端200点 → 前端50点，存在三级压缩</p>
                <p><strong>影响：</strong>可能丢失重要的故障特征信息，影响诊断准确性</p>
                <p><strong>建议：</strong>优化采样算法，确保保留关键频率分量和故障特征点</p>
            </div>
            
            <div class="warning-box">
                <h4>🟡 时间轴不一致</h4>
                <p><strong>问题：</strong>数据源使用相对时间，后端使用ISO时间戳，前端生成显示时间</p>
                <p><strong>影响：</strong>时间轴可能不够精确，影响多通道数据同步</p>
                <p><strong>建议：</strong>统一使用高精度时间戳，确保时间同步准确性</p>
            </div>
            
            <div class="warning-box">
                <h4>🟡 特征参数映射</h4>
                <p><strong>问题：</strong>前端预定义的特征参数可能与后端实际计算的特征不完全匹配</p>
                <p><strong>影响：</strong>某些故障类型的特征显示可能不准确</p>
                <p><strong>建议：</strong>建立动态特征参数映射机制</p>
            </div>

            <h3>优化建议</h3>
            
            <div class="success-box">
                <h4>✅ 数据结构统一化</h4>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li>建立统一的数据模型接口定义</li>
                    <li>实现类型安全的数据传输协议</li>
                    <li>添加数据完整性校验机制</li>
                </ul>
            </div>
            
            <div class="success-box">
                <h4>✅ 性能监控完善</h4>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li>添加端到端延迟监控</li>
                    <li>实现数据质量评估指标</li>
                    <li>建立异常数据自动处理机制</li>
                </ul>
            </div>
        </div>

        <!-- 总体评估 -->
        <div class="section">
            <h2>📈 总体评估结论</h2>
            
            <div class="highlight-box">
                <h3>🎯 对应关系评估</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 2.5em; color: #27ae60; font-weight: bold;">85%</div>
                        <div>数据类型匹配度</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2.5em; color: #f39c12; font-weight: bold;">75%</div>
                        <div>数据结构一致性</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2.5em; color: #27ae60; font-weight: bold;">90%</div>
                        <div>通信方式兼容性</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2.5em; color: #3498db; font-weight: bold;">82%</div>
                        <div>整体对应度</div>
                    </div>
                </div>
            </div>
            
            <div class="success-box">
                <h3>✅ 主要优势</h3>
                <ul style="margin-top: 15px; padding-left: 20px; font-size: 1.1em;">
                    <li><strong>数据流设计合理：</strong>从原始数据到可视化展示的链路设计基本合理</li>
                    <li><strong>性能优化到位：</strong>多级数据压缩和缓存机制有效控制内存使用</li>
                    <li><strong>实时性良好：</strong>WebSocket通信确保数据传输的实时性</li>
                    <li><strong>扩展性强：</strong>支持多种故障类型的统一处理框架</li>
                </ul>
            </div>
            
            <div class="warning-box">
                <h3>⚠️ 需要关注的问题</h3>
                <ul style="margin-top: 15px; padding-left: 20px; font-size: 1.1em;">
                    <li><strong>数据精度损失：</strong>多级压缩可能影响故障诊断的准确性</li>
                    <li><strong>时间同步问题：</strong>需要建立更精确的时间戳同步机制</li>
                    <li><strong>类型安全性：</strong>缺乏严格的数据类型校验和错误处理</li>
                    <li><strong>可观测性不足：</strong>需要更完善的数据流监控和诊断机制</li>
                </ul>
            </div>
            
            <p style="font-size: 1.2em; font-weight: bold; text-align: center; margin-top: 30px; color: #2c3e50;">
                🔍 总结：整体数据流链路设计基本合理，数据类型和结构在各环节间基本保持一致，
                通信方式统一采用WebSocket协议，确保了系统的实时性和性能。
                建议重点关注数据精度保持和时间同步优化。
            </p>
        </div>
    </div>

    <div class="footer">
        <p>© 2024 车联网故障诊断系统 - 数据流分析报告</p>
        <p>分析工程师：AI Assistant | 分析时间：2024年12月</p>
    </div>
</body>
</html> 